<!DOCTYPE html>
<html>
    <head>
        <title>Eternal Darkness Spells</title>
        <style>
            :root {
                --background-color: White;
                --color: Black;
                --chatturgha-color: Maroon;
                --ulyaoth-color: MediumBlue;
                --xellotath-color: DarkGreen;
                --mantorok-color: DarkMagenta;
                --unaligned-color: SaddleBrown;
                --incompatible-color: Silver;
            }
            @media (prefers-color-scheme: dark) {
                :root {
                    --background-color: Black;
                    --color: White;
                    --chatturgha-color: Tomato;
                    --ulyaoth-color: DeepSkyBlue;
                    --xellotath-color: SpringGreen;
                    --mantorok-color: Violet;
                    --unaligned-color: Khaki;
                    --incompatible-color: DimGray;
                }
            }
            body {
                background-color: var(--background-color);
                color: var(--color);
                padding: 1rem;
            }
            table, .rune {
                border: 1px solid var(--color);
            }
            td {
                padding: 1rem;
            }
            .rune {
                cursor: pointer;
            }
            #chatturgha, .chatturgha .rune.selected { color: var(--chatturgha-color); }
            #ulyaoth, .ulyaoth .rune.selected { color: var(--ulyaoth-color); }
            #xellotath, .xellotath .rune.selected { color: var(--xellotath-color); }
            #mantorok, .mantorok .rune.selected { color: var(--mantorok-color); }
            .unaligned .rune.selected { color: var(--unaligned-color); }
            .rune.inactive { color: var(--incompatible-color) !important; }
        </style>
    </head>
    <body>
        <h1>Eternal Darkness Spells</h1>
        <table class="unaligned" id="spellTable">
            <tr>
                <th>Alignment</th>
                <th>Verb</th>
                <th>Noun</th>
                <th>Spell</th>
            </tr>
            <tr>
                <td class="rune" id="chatturgha" data-type="alignment">Chattur'gha (Claw)</td>
                <td class="rune" id="bankorok" data-type="verb">Bankorok (Protect)</td>
                <td class="rune" id="magormor" data-type="noun">Magormor (Item)</td>
                <td class="rune" id="enchant" data-type="spell">Enchant Item</td>
            </tr>
            <tr>
                <td class="rune" id="ulyaoth" data-type="alignment">Ulyaoth (Veil)</td>
                <td class="rune" id="tier" data-type="verb">Tier (Summon)</td>
                <td class="rune" id="redgormor" data-type="noun">Redgormor (Area)</td>
                <td class="rune" id="recover" data-type="spell">Recover</td>
            </tr>
            <tr>
                <td class="rune" id="xellotath" data-type="alignment">Xel'lotath (Sigil)</td>
                <td class="rune" id="narokath" data-type="verb">Narokath (Absorb)</td>
                <td class="rune" id="aretak" data-type="noun">Aretak (Creature)</td>
                <td class="rune" id="reveal" data-type="spell">Reveal Invisible</td>
            </tr>
            <tr>
                <td class="rune" id="mantorok" data-type="alignment">Mantorok (Black Heart)</td>
                <td class="rune" id="nethlek" data-type="verb">Nethlek (Dispel)</td>
                <td class="rune" id="santak" data-type="noun">Santak (Self)</td>
                <td class="rune" id="field" data-type="spell">Damage Field</td>
            </tr>
            <tr>
                <td></td>
                <td class="rune" id="antorbok" data-type="verb">Antorbok (Project)</td>
                <td class="rune" id="pargon" data-type="noun">Pargon (Power)</td>
                <td class="rune" id="dispel" data-type="spell">Dispel Magick</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="rune" id="summon" data-type="spell">Summon Creature</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="rune" id="shield" data-type="spell">Shield</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="rune" id="attack" data-type="spell">Magickal Attack</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="rune" id="pool" data-type="spell">Magick Pool</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="rune" id="bind" data-type="spell">Bind</td>
            </tr>
        </table>
        <script>
            const spellDict = {
                'enchant': ['antorbok', 'magormor'],
                'recover': ['narokath', 'santak'],
                'reveal': ['narokath', 'redgormor'],
                'field': ['bankorok', 'redgormor'],
                'dispel': ['nethlek', 'redgormor'],
                'summon': ['tier', 'aretak'],
                'shield': ['bankorok', 'santak'],
                'attack': ['antorbok', 'redgormor'],
                'pool': ['tier', 'redgormor'],
                'bind': ['bankorok', 'aretak']
            };
            const spellMatrix = [
                ['enchant', 'antorbok', 'magormor', 'pargon', 'chatturgha'],
                ['recover', 'narokath', 'santak', 'pargon', 'chatturgha'],
                ['reveal', 'narokath', 'redgormor', 'pargon', 'chatturgha'],
                ['field', 'bankorok', 'redgormor', 'pargon', 'chatturgha'],
                ['dispel', 'nethlek', 'redgormor', 'pargon', 'chatturgha'],
                ['summon', 'tier', 'aretak', 'pargon', 'chatturgha'],
                ['shield', 'bankorok', 'santak', 'pargon', 'chatturgha'],
                ['attack', 'antorbok', 'redgormor', 'pargon', 'chatturgha'],
                ['pool', 'tier', 'redgormor', 'pargon', 'chatturgha'],
                ['bind', 'bankorok', 'aretak', 'pargon', 'chatturgha'],
                ['enchant', 'antorbok', 'magormor', 'pargon', 'ulyaoth'],
                ['recover', 'narokath', 'santak', 'pargon', 'ulyaoth'],
                ['reveal', 'narokath', 'redgormor', 'pargon', 'ulyaoth'],
                ['field', 'bankorok', 'redgormor', 'pargon', 'ulyaoth'],
                ['dispel', 'nethlek', 'redgormor', 'pargon', 'ulyaoth'],
                ['summon', 'tier', 'aretak', 'pargon', 'ulyaoth'],
                ['shield', 'bankorok', 'santak', 'pargon', 'ulyaoth'],
                ['attack', 'antorbok', 'redgormor', 'pargon', 'ulyaoth'],
                ['pool', 'tier', 'redgormor', 'pargon', 'ulyaoth'],
                ['bind', 'bankorok', 'aretak', 'pargon', 'ulyaoth'],
                ['enchant', 'antorbok', 'magormor', 'pargon', 'xellotath'],
                ['recover', 'narokath', 'santak', 'pargon', 'xellotath'],
                ['reveal', 'narokath', 'redgormor', 'pargon', 'xellotath'],
                ['field', 'bankorok', 'redgormor', 'pargon', 'xellotath'],
                ['dispel', 'nethlek', 'redgormor', 'pargon', 'xellotath'],
                ['summon', 'tier', 'aretak', 'pargon', 'xellotath'],
                ['shield', 'bankorok', 'santak', 'pargon', 'xellotath'],
                ['attack', 'antorbok', 'redgormor', 'pargon', 'xellotath'],
                ['pool', 'tier', 'redgormor', 'pargon', 'xellotath'],
                ['bind', 'bankorok', 'aretak', 'pargon', 'xellotath'],
                ['enchant', 'antorbok', 'magormor', 'pargon', 'mantorok'],
                ['recover', 'narokath', 'santak', 'pargon', 'mantorok'],
                ['reveal', 'narokath', 'redgormor', 'pargon', 'mantorok'],
                ['field', 'bankorok', 'redgormor', 'pargon', 'mantorok'],
                ['dispel', 'nethlek', 'redgormor', 'pargon', 'mantorok'],
                ['shield', 'bankorok', 'santak', 'pargon', 'mantorok'],
                ['attack', 'antorbok', 'redgormor', 'pargon', 'mantorok'],
                ['pool', 'tier', 'redgormor', 'pargon', 'mantorok'],
                ['bind', 'bankorok', 'aretak', 'pargon', 'mantorok']
            ];
            const runes = document.getElementsByClassName('rune');
            Array.from(runes).forEach(rune => {
                rune.addEventListener('click', function(e) {
                    /* don't disable or enable anything as pargon is compatible with all other nouns */
                    if (e.target.id === 'pargon') {
                        e.target.classList.toggle('selected');
                    }
                    else if (e.target.classList.toggle('selected')) {
                        /* remove selected from any other runes of same type */
                        Array.from(runes).forEach(rune => {
                            if (rune.dataset.type === e.target.dataset.type && !rune.isSameNode(e.target) && rune.id !== 'pargon') { /* pargon is always enabled */
                                rune.classList.remove('selected');
                            }
                        });
                        /* set alignment on table for color coding */
                        if (e.target.dataset.type === 'alignment') {
                            document.getElementById('spellTable').className = e.target.id;
                        }
                        /* if a spell is selected also select corresponding runes */
                        else if (e.target.dataset.type === 'spell') {
                            Array.from(document.getElementsByClassName('selected')).forEach(rune => {
                                if (!rune.isSameNode(e.target) && rune.dataset.type !== 'alignment' && rune.id !== 'pargon') { /* pargon can always be selected */
                                    rune.classList.remove('selected');
                                }
                            });
                            let verb = document.getElementById(spellDict[e.target.id][0]);
                            let noun = document.getElementById(spellDict[e.target.id][1]);
                            verb.classList.add('selected');
                            noun.classList.add('selected');
                            /* special mantorok case */
                            if (document.getElementById('spellTable').className === 'mantorok' && e.target.id === 'summon') {
                                document.getElementById('spellTable').className = 'unaligned';
                            }
                        }
                    }
                    else {
                        /* reset alignment color coding */
                        if (e.target.dataset.type === 'alignment') {
                            document.getElementById('spellTable').className = 'unaligned';
                        }
                        else if (e.target.dataset.type === 'spell') {
                            Array.from(runes).forEach(rune => {
                                if (rune.dataset.type !== 'alignment') {
                                    rune.classList.remove('inactive', 'selected');
                                }
                            });
                        }
                    }
                    determineSpell();
                    toggleInactive(document.getElementById('spellTable').className !== 'unaligned');
                });
            });

            function toggleInactive(aligned) {
                let selectedRunes = [];
                Array.from(document.getElementsByClassName('selected')).forEach(rune => {
                    selectedRunes.push(rune.id);
                });
                let possibleSpells = [];
                let activeRunes = [];
                spellMatrix.forEach(spell => {
                    if (selectedRunes.every(rune => spell.includes(rune))) {
                        possibleSpells.push(spell);
                    }
                });
                activeRunes = union(...possibleSpells);
                Array.from(runes).forEach(rune => {
                    rune.classList.remove('inactive');
                    if ((!activeRunes.includes(rune.id) || (aligned && rune.dataset.type === 'alignment')) && !rune.classList.contains('selected')) { /* special case for alignment they are common to all spells */
                        rune.classList.add('inactive');
                    }
                });
            }

            function determineSpell() {
                Array.from(document.querySelectorAll("[data-type='spell']")).forEach(spell => {
                    spell.classList.remove('selected');
                });
                verb = document.querySelector("[data-type='verb'].selected");
                noun = document.querySelector("[data-type='noun'].selected"); /* this is ok as pargon comes after all other nouns */
                if (verb && noun && noun.id !== 'pargon') { /* ignore pargon since it has no semantical meaning */
                    for (let [key, value] of Object.entries(spellDict)) {
                        if ([verb.id, noun.id].every(rune => value.includes(rune))) {
                            if (!(document.getElementById('spellTable').className === 'mantorok' && key === 'summon')) { /* special mantorok case */
                                document.getElementById(key).classList.add('selected');
                            }
                        }
                    }
                }
            }

            function union() {
                let flat = [].concat(...arguments);
                return [...new Set(flat)];
            }
        </script>
    </body>
</html>
